# Live Gateway Test Suite

This directory contains a comprehensive test script for the live gateway that simulates continuous accelerometer data and visualizes the results.

## Test Script: `test_live_gateway.py`

### Features

1. **Realistic Accelerometer Simulation**
   - 50 Hz sampling rate (typical for fitness wearables)
   - Simulates squat movement with descent, bottom, ascent, and top phases
   - Implements progressive fatigue over the 20-second test period
   - Adds realistic noise to acceleration data

2. **Continuous Data Streaming**
   - Connects to Socket.IO server at `http://localhost:3001`
   - Sends real-time accelerometer samples
   - Automatically detects rep completion based on velocity patterns
   - Emits rep events and set updates

3. **Real-time Visualization**
   - **Plot 1**: Real-time bar velocity over time
   - **Plot 2**: Raw accelerometer data (acceleration)
   - **Plot 3**: Rep-by-rep metrics (speed and TUT)
   - **Plot 4**: Set summary with coaching tips

4. **Comprehensive Metrics**
   - Time Under Tension (TUT) per rep
   - Average velocity per rep
   - ROM (Range of Motion) hit detection
   - Velocity loss calculation
   - Fatigue simulation

### Installation

Install the required dependencies:

```bash
pip install -r src/test_requirements.txt
```

Or install manually:

```bash
pip install python-socketio[asyncio-client] numpy matplotlib aiohttp
```

### Usage

1. **Start the backend server** (make sure it's running on port 3001):
   ```bash
   python src/main.py
   ```

2. **Run the test in a separate terminal**:
   ```bash
   python src/test_live_gateway.py
   ```

3. **Watch the magic happen**:
   - The test will run for 20 seconds
   - Real-time plots will update continuously
   - After 20 seconds, you'll see:
     - Final visualization of all data
     - Set summary statistics
     - Coaching tips generated by the calculation service
     - Rep-by-rep breakdown

### What the Test Does

```
Timeline (20 seconds):

0s  ──→ Connect to Socket.IO server
     ──→ Send 'startSet' event
     ──→ Begin continuous data stream (50 Hz)
     
~3s ──→ First rep detected
     ──→ Send rep event with metrics
     
~6s ──→ Second rep detected (slightly slower due to fatigue)
     
~9s ──→ Third rep detected
     
... continues for ~6-8 reps total

20s ──→ Stop data stream
     ──→ Send 'endSet' event with all reps
     ──→ Receive set summary from calculation service
     ──→ Display final plots and coaching tips
```

### Expected Output

**Console Output:**
```
============================================================
STARTING CONTINUOUS DATA STREAM
============================================================
Duration: 20 seconds
Sampling Rate: 50 Hz
Expected Reps: ~6-8
============================================================

Rep detected: rep-1 - Valid: True
Set update: 1 reps, VL: 0.0%, RIR: 5
Rep detected: rep-2 - Valid: True
Set update: 2 reps, VL: 8.2%, RIR: 4
...

============================================================
SET COMPLETE!
============================================================
Reps: 7
Total TUT: 24.5s
Avg Speed: 0.38 m/s
Velocity Loss: 18.4%
ROM Hit Rate: 85.7%
ROM Variability: 2.1 cm

Coaching Tip: Solid set! VL at 18% with 86% ROM hits. Stay consistent.
============================================================
```

**Plots Window:**
- Four subplots showing real-time data and analysis
- Interactive matplotlib window that stays open after test completes

### Customization

You can modify the test parameters in `test_live_gateway.py`:

```python
# Change test duration (default: 20 seconds)
self.set_duration = 30  

# Change sampling rate (default: 50 Hz)
self.simulator = AccelerometerSimulator(sampling_rate=100)

# Change server URL (default: http://localhost:3001)
tester = LiveGatewayTester(server_url="http://localhost:5000")
```

### Troubleshooting

**Problem**: `Connection refused`
- **Solution**: Make sure the backend server is running on port 3001

**Problem**: `Import "socketio" could not be resolved`
- **Solution**: Install dependencies: `pip install python-socketio[asyncio-client]`

**Problem**: No plots showing
- **Solution**: Make sure matplotlib is installed and you have a display backend configured

**Problem**: Test hangs at connection
- **Solution**: Check that the server is accepting Socket.IO connections and CORS is configured

### Technical Details

**Accelerometer Simulation:**
- Uses sinusoidal patterns to simulate realistic bar movement
- Descent: negative acceleration (gravity + controlled lowering)
- Bottom: brief reversal/pause
- Ascent: positive acceleration (explosive concentric)
- Top: settling back to rest

**Fatigue Modeling:**
- Progressive velocity degradation over time
- Increased ROM miss rate with fatigue
- Longer rep duration as fatigue increases
- Quality factor: `1.0 - (elapsed_time / total_time * 0.7)`

**Rep Detection:**
- Monitors velocity patterns
- Detects rep completion when velocity drops below threshold
- Requires minimum samples (~0.5 seconds) to validate rep

### Integration with Calculation Service

The test script sends data that matches the expected format for `calculation_service.py`:

```python
RepEvent {
    id: str,              # "rep-1", "rep-2", etc.
    valid: bool,          # True if rep meets quality standards
    metrics: {
        tut: float,       # Time under tension in seconds
        speed: float,     # Average bar speed in m/s
        vl: float,        # Velocity loss percentage
        romHit: bool      # Whether ROM target was hit
    },
    ts: int              # Timestamp in milliseconds
}
```

The calculation service responds with:

```python
SetEnd {
    summary: {
        reps: int,
        tut: float,
        avg_speed: float,
        vl: float,
        rom_hit_rate: float,
        rom_variability: float
    },
    tip: str             # Coaching tip based on performance
}
```

---

## Additional Test Files

You can create additional test scenarios:

### `test_explosive_set.py` - Test fast, explosive reps
### `test_fatigue_set.py` - Test high-fatigue training
### `test_form_breakdown.py` - Test ROM consistency issues

Each test can be customized to simulate different training conditions and validate the calculation service's response.
